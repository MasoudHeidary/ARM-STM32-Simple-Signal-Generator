/*
 * APP.c
 *
 *  Created on: Jun 16, 2022
 *      Author: Masoud
 */

#include "APP.h"

#include "lcd.h"
#include <stdio.h>
#include <stdlib.h>


char MENU_LIST[MENU_LIST_LEN][16] = {
		"Sine Wave(1)",
		"Square Wave(2)",
		"Triangle (3)",
		"Sawtooth (4)"
};

void APP_init(void) {
	_rxFlag = false;
	_menuDisplayPointer = 0;
	_menuChoice = 0;

	APP_menuInit();

	APP_UARTInit();

	APP_waveInit();
}

// MENU -----------------------------------------------
void APP_menuInit(void) {
	lcd_init();
	lcd_clear();
	lcd_puts("Application...");
	HAL_Delay(3000);
	lcd_clear();
}

// show options on lcd
void APP_lcdMenuUpdate(void) {
	// print 2 choice per page
	int page = _menuDisplayPointer / MENU_OPTION_PER_PAGE;

	lcd_clear();
	for(int i=0; i<MENU_OPTION_PER_PAGE; i++) {
		lcd_gotoxy(1, i);
		lcd_puts(MENU_LIST[page * MENU_OPTION_PER_PAGE + i]);

		if((page * MENU_OPTION_PER_PAGE + i) == _menuDisplayPointer) {
			lcd_gotoxy(0, i);
			lcd_putchar('>');
		}
	}
}

// show message for selected option
void APP_lcdMenuSelect(void) {
	lcd_clear();
	lcd_gotoxy(0, 0);
	lcd_puts("Generating...");
	lcd_gotoxy(0, 1);
	lcd_puts(MENU_LIST[_menuChoice]);

	HAL_Delay(5000);
	APP_lcdMenuUpdate();
}


// go to next option in menu
void APP_menuNextOption(void) {
	_menuDisplayPointer = (_menuDisplayPointer + 1) % MENU_LIST_LEN;
	APP_lcdMenuUpdate();
}

// select current displayed option as selected option
void APP_menuSelectOption(void) {
	_menuChoice = _menuDisplayPointer;

	// reset output wave
	_DACPointer = 0;

	APP_lcdMenuSelect();
}


// UART -----------------------------
char _rx[1];
bool _rxFlag;

void APP_UARTInit(void) {
	HAL_UART_Receive_IT(APP_UART, (uint8_t *)_rx, 1);
}

void APP_UARTMenuSelect(void) {
	if(!_rxFlag)
		return;

	_rxFlag = false;
	APP_lcdMenuSelect();
}

void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart) {
	if(huart == APP_UART) {
		char selected_code = _rx[0];

		if(selected_code >= '1' && selected_code <= '4') {
			_menuChoice = selected_code - '1';
			_rxFlag = true;

			char str[20] = "";
			sprintf(str, "%d selected", _menuChoice);

			HAL_UART_Transmit_DMA(APP_UART, (uint8_t*)str, 20);
		}

		APP_UARTInit();
	}
}

// DAC & Timer ----------------------------
int _DACPointer = 0;

uint32_t DACValue_Sine[] = {
		0x800,0x880,0x900,0x97f,0x9fd,0xa78,0xaf1,0xb67,0xbda,0xc49,
		0xcb3,0xd19,0xd79,0xdd4,0xe29,0xe78,0xec0,0xf02,0xf3c,0xf6f,
		0xf9b,0xfbf,0xfdb,0xfef,0xffb,0xfff,0xffb,0xfef,0xfdb,0xfbf,
		0xf9b,0xf6f,0xf3c,0xf02,0xec0,0xe78,0xe29,0xdd4,0xd79,0xd19,
		0xcb3,0xc49,0xbda,0xb67,0xaf1,0xa78,0x9fd,0x97f,0x900,0x880,
		0x800,0x77f,0x6ff,0x680,0x602,0x587,0x50e,0x498,0x425,0x3b6,
		0x34c,0x2e6,0x286,0x22b,0x1d6,0x187,0x13f,0xfd,0xc3,0x90,
		0x64,0x40,0x24,0x10,0x4,0x0,0x4,0x10,0x24,0x40,
		0x64,0x90,0xc3,0xfd,0x13f,0x187,0x1d6,0x22b,0x286,0x2e6,
		0x34c,0x3b6,0x425,0x498,0x50e,0x587,0x602,0x680,0x6ff,0x77f,
};

uint32_t DACValue_Square[] = {
		0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF,
		0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF,
		0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF,
		0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF,
		0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF, 0xFFF,
		0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000,
		0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000,
		0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000,
		0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000,
		0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000,
};

uint32_t DACValue_Triangle[] = {
		0x52,0xa4,0xf6,0x148,0x19a,0x1eb,0x23d,0x28f,0x2e1,0x333,
		0x385,0x3d7,0x429,0x47b,0x4cd,0x51e,0x570,0x5c2,0x614,0x666,
		0x6b8,0x70a,0x75c,0x7ae,0x800,0x851,0x8a3,0x8f5,0x947,0x999,
		0x9eb,0xa3d,0xa8f,0xae1,0xb33,0xb84,0xbd6,0xc28,0xc7a,0xccc,
		0xd1e,0xd70,0xdc2,0xe14,0xe66,0xeb7,0xf09,0xf5b,0xfad,0xfff,
		0xfad,0xf5b,0xf09,0xeb7,0xe66,0xe14,0xdc2,0xd70,0xd1e,0xccc,
		0xc7a,0xc28,0xbd6,0xb84,0xb33,0xae1,0xa8f,0xa3d,0x9eb,0x999,
		0x947,0x8f5,0x8a3,0x851,0x800,0x7ae,0x75c,0x70a,0x6b8,0x666,
		0x614,0x5c2,0x570,0x51e,0x4cd,0x47b,0x429,0x3d7,0x385,0x333,
		0x2e1,0x28f,0x23d,0x1eb,0x19a,0x148,0xf6,0xa4,0x52,0x0,
};

uint32_t DACValue_Sawtooth[] = {
		0x28,0x51,0x7a,0xa3,0xcc,0xf5,0x11e,0x147,0x170,0x199,
		0x1c2,0x1eb,0x214,0x23d,0x266,0x28f,0x2b8,0x2e1,0x30a,0x333,
		0x35b,0x384,0x3ad,0x3d6,0x3ff,0x428,0x451,0x47a,0x4a3,0x4cc,
		0x4f5,0x51e,0x547,0x570,0x599,0x5c2,0x5eb,0x614,0x63d,0x666,
		0x68e,0x6b7,0x6e0,0x709,0x732,0x75b,0x784,0x7ad,0x7d6,0x7ff,
		0x828,0x851,0x87a,0x8a3,0x8cc,0x8f5,0x91e,0x947,0x970,0x999,
		0x9c1,0x9ea,0xa13,0xa3c,0xa65,0xa8e,0xab7,0xae0,0xb09,0xb32,
		0xb5b,0xb84,0xbad,0xbd6,0xbff,0xc28,0xc51,0xc7a,0xca3,0xccc,
		0xcf4,0xd1d,0xd46,0xd6f,0xd98,0xdc1,0xdea,0xe13,0xe3c,0xe65,
		0xe8e,0xeb7,0xee0,0xf09,0xf32,0xf5b,0xf84,0xfad,0xfd6,0xfff
};

uint32_t* DACWaves[4] = {
		DACValue_Sine,
		DACValue_Square,
		DACValue_Triangle,
		DACValue_Sawtooth,
};

void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim) {
	if (htim == APP_Timer) {
		_DACPointer = (_DACPointer + 1) % 100;

		HAL_DAC_SetValue(APP_DAC, DAC_CHANNEL_1, DAC_ALIGN_12B_R, DACWaves[_menuChoice][_DACPointer]);
	}
}

void APP_waveInit(void) {
	HAL_TIM_Base_Start_IT(APP_Timer);
	HAL_DAC_Start(APP_DAC, DAC_CHANNEL_1);
}
